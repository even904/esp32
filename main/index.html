<!DOCTYPE html>
<html>
<head>
    <title>ESP32 è®¾ç½®</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 400px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        input[type=text],
        input[type=password] {
            width: calc(100% - 22px);
            padding: 10px;
            margin: 10px 0;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        /* æˆåŠŸæ¶ˆæ¯æ ·å¼ */
        #successMessage {
            display: none; /* é»˜è®¤éšè— */
            margin-top: 20px;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            text-align: center;
            color: #155724;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>è¿æ¥è®¾ç½®</h2>
    <form id="settingsForm">
        <label for="ssid"><b>SSID</b></label>
        <input type="text" placeholder="è¾“å…¥ Wi-Fi SSID" name="ssid">

        <label for="password"><b>Password</b></label>
        <input type="password" placeholder="è¾“å…¥ Wi-Fi å¯†ç " name="password">

        <label for="conn_retry"><b>WiFiæ–­è¿é‡è¯•æ¬¡æ•°</b></label>
        <input type="text" placeholder="è¾“å…¥wifiæ–­è¿é‡è¯•æ¬¡æ•°ï¼Œé—´éš”ä¸º1s" name="conn_retry">

        <h2>å¤©æ°”è®¾ç½®</h2>
        <label for="api_key"><b>API_KEY</b></label>
        <input type="text" placeholder="è¾“å…¥Amapå¼€æ”¾å¹³å°çš„API_KEY" name="api_key">

        <label for="city_code"><b>åŸå¸‚ç¼–ç </b></label>
        <input type="text" placeholder="è¾“å…¥6ä½åŸå¸‚ç¼–ç " name="city_code">

        <h2>å¤–è§‚è®¾ç½®</h2>
        <label for="bg_image"><b>èƒŒæ™¯å›¾ç‰‡ï¼ˆå¡«å†™ç¼–å·ï¼‰</b></label>
        <input type="text" placeholder="è¾“å…¥èƒŒæ™¯å›¾ç‰‡ç¼–å·ï¼Œå½“å‰0~5æœ‰æ•ˆ" name="bg_image">

        <button type="submit">ä¿å­˜</button>
    </form>
    <div id="successMessage">ä¿å­˜æˆåŠŸï¼</div>
    <div> PSï¼šè®¿é—® https://lbs.amap.com/api/webservice/download è·å–åŸå¸‚ç¼–ç è¡¨ </div>
</div>

<script>
document.getElementById('settingsForm').addEventListener('submit', function(event) {
    event.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º

    // è·å–è¡¨å•ä¸­çš„æ‰€æœ‰è¾“å…¥å…ƒç´ 
    const formData = new FormData(this);
    const formFields = {
        ssid: formData.get('ssid'),
        password: formData.get('password'),
        conn_retry: formData.get('conn_retry'),
        api_key: formData.get('api_key'),
        city_code: formData.get('city_code'),
        bg_image: formData.get('bg_image')
    };

    // é•¿åº¦æ ¡éªŒè§„åˆ™
    const validationRules = {
        ssid: { min: 1, max: 32 }, // SSIDæœ€å°é•¿åº¦ä¸º1ï¼Œæœ€å¤§é•¿åº¦ä¸º32
        password: { min: 8, max: 64 }, // Wi-Fi å¯†ç æœ€å°é•¿åº¦ä¸º8ï¼Œæœ€å¤§é•¿åº¦ä¸º64
        conn_retry: { min: 1, max: 5 }, // WiFiæ–­è¿é‡è¯•æ¬¡æ•°æœ€å°é•¿åº¦ä¸º1ï¼Œæœ€å¤§é•¿åº¦ä¸º3
        api_key: { min: 32, max: 32 }, // Amapå¼€æ”¾å¹³å°çš„API_KEYæœ€å°é•¿åº¦ä¸º10ï¼Œæœ€å¤§é•¿åº¦ä¸º50
        city_code: { min: 6, max: 6 }, // åŸå¸‚ç¼–ç é•¿åº¦ä¸º6
        bg_image: { min: 1, max: 2 } // èƒŒæ™¯å›¾ç‰‡ç¼–å·é•¿åº¦ä¸º1æˆ–2
    };

    // å¯é€‰å­—æ®µå…è®¸ä¸ºç©º
    const optionalFields = ['ssid', 'password', 'conn_retry', 'api_key', 'city_code', 'bg_image'];

    // éªŒè¯é€»è¾‘
    let isValid = true;
    for (const [field, value] of Object.entries(formFields)) {
        const fieldRules = validationRules[field];
        if (fieldRules) {
            // å¦‚æœå­—æ®µæ˜¯å¯é€‰çš„ä¸”ä¸ºç©ºï¼Œåˆ™è·³è¿‡éªŒè¯
            if (optionalFields.includes(field) && value.trim() === '') {
                continue;
            }

            if (value.length < fieldRules.min || value.length > fieldRules.max) {
                isValid = false;
                alert(`${field.toUpperCase()} çš„è¾“å…¥é•¿åº¦åº”åœ¨ ${fieldRules.min}-${fieldRules.max} ä¹‹é—´ã€‚`);
                break;
            }
        }
    }

    // å¦‚æœè¾“å…¥æœ‰æ•ˆï¼Œåˆ™æäº¤æ•°æ®
    if (isValid) {
        // å°†è¡¨å•æ•°æ®è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡
        const formObject = {};
        formData.forEach((value, key) => formObject[key] = value);

        // å°†è¡¨å•æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
        const jsonData = JSON.stringify(formObject);

        // ä½¿ç”¨fetch APIæäº¤æ•°æ®
        fetch('/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: jsonData
        })
        .then(response => {
            if (response.ok) {
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æ¶ˆæ¯
                const successMessage = document.getElementById('successMessage');
                successMessage.style.display = 'block';

                // å‡ ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000); // 3000æ¯«ç§’ = 3ç§’
            } else {
                throw new Error('æœåŠ¡å™¨å“åº”å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert("ä¿å­˜æˆåŠŸäº†ï¼Œä½†æœåŠ¡å™¨æ‡’å¾—å“åº”ã€‚ï¼ˆæˆ–è€…ä¿å­˜å¤±è´¥äº†ğŸ‘¿ï¼‰");
        });
    }
});
</script>

</body>
</html>